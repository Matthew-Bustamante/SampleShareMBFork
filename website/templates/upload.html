{% extends 'base.html' %}
{% load static %}
{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Sample</title>
    <style>
        #drop-zone {
            width: 70%;
            height: 300px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: #666;
        }
        .file-item {
            margin: 10px 0;
        }
        .genre-tag {
            border-radius: 12px;
            padding: 4px 8px;
            margin: 0 4px;
            display: flex;
            align-items: center;
            color: #e0e0e0; /* Light text color for visibility */
            background-color: #202830; /* Dark background matching profile card */
        }
        .genre-tag button {
            background: none;
            border: none;
            font-size: 12px;
            margin-left: 4px;
            cursor: pointer;
            color: #e0e0e0; /* Ensure the remove button text is also legible */
        }
        #genre-suggestions {
            border-radius: 8px;
            padding: 8px;
            margin: 4px 0; /* Spacing between suggestions */
            color: #e0e0e0; /* Light text color */
            background-color: #202830; /* Dark background */
            cursor: pointer; /* Change cursor to indicate interactivity */
            transition: background-color 0.3s; /* Smooth background color change */
            width: 150px; /* Set a fixed width for narrowness */
            text-align: center; /* Center the text within the suggestion */
        }

        .suggestion-item {
            display: block; /* Each suggestion takes a full line */
            width: 100%; /* Full width */
            text-align: left; /* Align text to the left */
            padding: 10px; /* Padding for better clickability */
        }

        .suggestion-item:hover {
            background-color: #362d4b; /* Light background on hover */
        }
    </style>
    <script src="{% static 'js/genre_autocomplete.js' %}"></script>
</head>
<body>

    <h1>Upload Samples</h1>

    <div id="drop-zone">Drag and drop files here</div>
    <ul id="file-list"></ul>

    <form id="SampleUploadForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" id="userProfiles" name="userProfiles" value="{{ request.user.userprofile.id }}">
        <!-- Genre Selection Section -->
        <div style="display: flex; align-items: center; margin-top: 16px;">
            <label for="id_genres" style="margin-right: 8px;">Tags:</label>
            <div style="display: flex; align-items: center;">
                <input type="text" id="id_genres" placeholder="Search genres..." style="width: 150px; padding-right: 24px;">
                <button type="button" id="add-genre-btn" style="margin-left: -28px; padding: 0 8px; font-size: 18px;">+</button>
            </div>
            <!-- Container for displaying selected genres inline -->
            <div id="selected-genres-inline" class="selected-genres" style="display: flex; align-items: center; margin-left: 8px;"></div>
        </div>

        <!-- Suggestions for genres -->
        <div id="genre-suggestions" class="suggestions-box"></div>

        <button type="button" id="submit-btn">Upload</button>
        <button type="button" onclick="window.location.href='/'">Cancel</button>
    </form>

    <script>
        // Drop Zone and File Queue Logic
        var dropZone = document.getElementById('drop-zone');
        var fileList = document.getElementById('file-list');
        var fileQueue = [];

        dropZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            dropZone.style.backgroundColor = '#eee';
        });

        dropZone.addEventListener('dragleave', function (e) {
            dropZone.style.backgroundColor = '#000000';
        });

        dropZone.addEventListener('drop', function (e) {
            e.preventDefault();
            var files = e.dataTransfer.files;

            for (var i = 0; i < files.length; i++) {
                var file = files[i];

                // Validate if the file is an audio file using MIME type check
                if (!file.type.startsWith('audio/')) {
                    alert('Only audio files are allowed.');
                    continue;
                }

                // Validate file by checking its duration asynchronously
                validateAndAddFile(file);
            }
        });

        function validateAndAddFile(file) {
            var audio = new Audio();
            audio.src = URL.createObjectURL(file);

            audio.addEventListener('loadedmetadata', function () {
                var duration = audio.duration;

                // Check if the file duration is 7 seconds or longer
                if (duration >= 7) {
                    alert('Files longer than 6 seconds are not allowed.');
                    return;  // Don't add the invalid file
                }

                addFileToList(file);
            });

            audio.addEventListener('error', function () {
                alert('Error loading audio file. This file cannot be added.');
            });
        }

        function addFileToList(file) {
            if (fileQueue.some(f => f.name === file.name)) {
                alert('This file is already in the queue.');
                return;
            }

            var fileItem = document.createElement('li');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name}</span>
                <input type="text" name="sampleName_${file.name}" placeholder="Rename">
                <label>Public? <input type="checkbox" name="isPublic_${file.name}"></label>
                <button type="button" onclick="removeFile('${file.name}', this)">Remove</button>
            `;
            fileList.appendChild(fileItem);
            fileQueue.push(file);
        }

        function removeFile(fileName, element) {
            fileQueue = fileQueue.filter(f => f.name !== fileName);
            element.parentElement.remove();
        }

        // Genre Autocomplete Logic
        const genreInput = document.getElementById('id_genres');
        const genreSuggestions = document.getElementById('genre-suggestions');
        const selectedGenresInline = document.getElementById('selected-genres-inline');
        const genreSet = new Set(); // To track selected genres

        document.getElementById('add-genre-btn').addEventListener('click', async function() {
            const genre = genreInput.value.trim();
            if (genre && !genreSet.has(genre)) {
                const response = await fetch('/create-genre/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ name: genre })
                });
                if (response.ok) {
                    addGenre(genre); // Add genre tag after creation
                    genreInput.value = ''; // Clear input
                    genreSuggestions.innerHTML = ''; // Clear suggestions
                } else {
                    alert("Failed to create genre.");
                }
            }
        });

        function addGenre(genre) {
            genreSet.add(genre);
            const genreTag = document.createElement('span');
            genreTag.className = 'genre-tag';
            genreTag.textContent = genre;
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Ã—';
            removeBtn.onclick = () => {
                genreSet.delete(genre);
                genreTag.remove();
            };
            genreTag.appendChild(removeBtn);
            selectedGenresInline.appendChild(genreTag);
        }

        document.getElementById('submit-btn').addEventListener('click', function (e) {
            if (fileQueue.length === 0) {
                alert("You must add a file to submit.");
                return;
            }

            // Add selected genres to form data
            const selectedGenreNames = Array.from(genreSet);
            if (selectedGenreNames.length > 0) {
                document.getElementById('SampleUploadForm').append(...selectedGenreNames.map(genre => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'genres'; // Make sure this matches your server-side logic
                    input.value = genre;
                    return input;
                }));
            }

            // Confirm before submission
            if (confirm("Are you sure you want to upload these files?")) {
                document.getElementById('submit-btn').disabled = true;

                uploadFiles(fileQueue).then(() => {
                    alert("All files uploaded successfully!");
                    fileQueue = [];  // Clear file queue
                    fileList.innerHTML = "";  // Clear UI
                    selectedGenresInline.innerHTML = ""; // Clear selected genres
                    genreSet.clear(); // Clear genre set
                    genreInput.value = ''; // Clear input
                    genreSuggestions.innerHTML = ''; // Clear suggestions
                    document.getElementById('submit-btn').disabled = false;
                }).catch(() => {
                    alert("There was an error uploading your files.");
                    document.getElementById('submit-btn').disabled = false;
                });
            }
        });

        genreInput.addEventListener('input', async function() {
            const query = genreInput.value.trim();
            if (query.length < 2) {
                genreSuggestions.innerHTML = ''; // Clear suggestions if too short
                genreSuggestions.style.display = 'none'; // Hide suggestions
                return;
            }
            const response = await fetch(`/search-genres/?query=${query}`);
            const suggestions = await response.json();
            genreSuggestions.innerHTML = suggestions.map(g => `<div class="suggestion-item">${g.name}</div>`).join('');
            genreSuggestions.style.display = suggestions.length > 0 ? 'block' : 'none'; // Show suggestions if there are results

            // Add click handler for suggestions
            const suggestionItems = document.querySelectorAll('.suggestion-item');
            suggestionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const selectedGenre = this.textContent;
                    if (!genreSet.has(selectedGenre)) {
                        addGenre(selectedGenre); // Add genre to inline display
                        genreInput.value = ''; // Clear input
                        genreSuggestions.innerHTML = ''; // Clear suggestions
                    }
                });
            });
        });
    </script>

</body>
{% endblock %}